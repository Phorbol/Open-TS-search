## 目标与原则
- 将当前单文件面向对象封装演进为可扩展的模块化架构，支持多个优化算法与组件的多版本共存
- 保持与现有使用方式和数值行为一致；严禁破坏性改动与不严谨处理
- 为 CCQN 各子组件提供清晰的边界与替换点，建立跨算法可重用的基础设施

## 包结构设计
- core/: 跨算法通用抽象
  - optimizer_base.py: 抽象 OptimizerBase，兼容 ASE Optimizer 生命周期与接口
  - hessian.py: 抽象 HessianInitializer/Updater 接口与通用工具
  - mode.py: 抽象 ModeSelector 接口（基于谱特征切换规则）
  - direction.py: 抽象 DirectionStrategy（interp/IDPP/IC）通用接口
  - step_solver.py: 抽象 StepSolver（Uphill/PRFO/RFO 子问题）
  - trust.py: 抽象 TrustRegionManager（线性半径 r 与更新因子）
  - convergence.py: 抽象 ConvergenceChecker
  - logging.py: 统一日志格式化与输出时机
- algo/
  - ccqn/
    - ccqn_v1_10.py: CCQN v1.10 顶层 Optimizer，组合所需子组件
    - components/
      - hessian_ts_bfgs_v1.py, hessian_ts_bfgs_v2.py: TS‑BFGS 多版本
      - mode_spectrum_v1.py: 最小特征值切换规则
      - direction_interp_v1.py: 线性/IDPP 中点方向（PBC/MIC）
      - direction_ic_democratic_v1.py, direction_ic_weighted_v1.py
      - step_uphill_slsqp_v1.py, step_prfo_rfo_v1.py
      - trust_linear_sqrt_sigma_v1.py
      - convergence_prfo_fmax_v1.py
  - other_algo_x/: 为未来算法预留同样结构
- shared/
  - pbc.py: PBC/MIC 相关向量化工具
  - numerics.py: 容差、钳制、伪逆、谱处理等通用数值工具
  - config.py: 不可变配置对象、版本标签与校验
- registry/
  - factory.py: 组件与算法工厂，按“算法名+版本”创建 Optimizer 或子组件
  - registry.py: 组件注册表，支持别名与回退策略

## 版本化策略
- 版本标识：组件级语义版本（如 ts_bfgs@v1、prfo_rfo@v1），算法级版本（ccqn@v1.10）
- 兼容策略：同一接口下可并行存在多个实现；默认版本通过工厂与注册表解析
- 回退与等价性：当新版本不可用或失败时，提供明确的回退实现与数值钳制保持

## 接口与依赖注入
- Optimizer 组合：顶层 Optimizer 仅依赖抽象接口，通过构造注入需要的组件实现
- 配置对象：使用不可变 Config；参数校验在工厂层进行，错误尽早暴露
- 可插拔组件：Direction、HessianUpdater、StepSolver、TrustRegion、Convergence 可替换
- IDPP/插值：以策略接口包装，保持对 Vectorized_ASE_IDPPSolver 与 robust_interpolate 的无缝接入

## 与现有代码的一致性要求
- CCQN v1.10 的日志文案、输出时机、阈值、PBC/MIC 行为、信任域更新因子严格一致
- 收敛判据组合（fmax 与 prfo 必达）保持不变；形状自适应（(3N,)→(N,3)）保留
- TS‑BFGS 与 RFO 子问题公式、失败回退路径不变；最终步长范数数值钳制保留

## 迁移计划
1. 抽象层落地：在 core/ 建立接口与共享工具（不改行为）
2. 提取 CCQN 组件到 algo/ccqn/components/ 并以 v1 命名；在 ccqn_v1_10.py 组合
3. 引入 registry/factory，实现按版本解析与默认版本配置
4. 保持 ccqn0.py 的旧入口，内部委托到新模块，确保现有脚本不需改动即可运行
5. 补充 PBC/MIC 与数值工具到 shared/ 并替换重复实现

## 测试与验证
- 导入与工厂测试：不同算法名/版本解析与实例化
- 组件等价性测试：对固定输入逐模块比较输出（容差内）；含 TS‑BFGS、RFO、SLSQP 回退
- 行为回归：在小分子/表面体系上对比模式序列、步长范数、rho、日志
- 边界场景：奇异 Hessian、零向量、约束失败、特征分解失败、IDPP 不可用

## 文档与示例
- README 说明包结构、版本选择、默认策略与回退机制
- 示例脚本：如何通过工厂创建 ccqn@v1.10，并切换 Direction/Trust/Hessian 的版本
- 组件矩阵：列出可替换点与当前实现版本

## 风险与对策
- 过度抽象导致性能回退：组件层保持轻量，避免不必要复制；关键路径向量化
- 版本冲突：注册表唯一命名与别名约定，工厂进行参数校验与冲突检测
- 依赖差异：针对 ASE/SciPy 版本进行特征检测，必要时提供兼容层

## 交付物
- 模块化目录与接口定义文档
- CCQN v1.10 组合实现（调用现有组件，数值完全一致）
- 回归与等价性测试套件，日志比对工具